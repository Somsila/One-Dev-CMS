import { eventHandler, getRouterParam, readValidatedBody } from "h3";
import * as z from "zod";
import loadDatabaseAdapter, { checkAndImportDatabaseIntegrity } from "../internal/database.server.js";
import { assertSafeQuery } from "../internal/security.js";
import { useRuntimeConfig } from "#imports";
export default eventHandler(async (event) => {
  const { sql } = await readValidatedBody(event, z.object({ sql: z.string() }).parse);
  const collection = getRouterParam(event, "collection");
  assertSafeQuery(sql, collection);
  const conf = useRuntimeConfig().content;
  await checkAndImportDatabaseIntegrity(event, collection, conf);
  return loadDatabaseAdapter(conf).all(sql);
});
